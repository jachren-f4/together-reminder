# Handover: Physical Device Testing Setup

**Date:** 2025-11-27
**Status:** Working - Both iPhones running Linked and Word Search successfully

---

## Summary

We successfully deployed the TogetherRemind API to Vercel and configured two physical iPhones to connect to it with different user accounts. Both Linked and Word Search games are now playable on both devices.

---

## Current Setup

### Devices & Users

| Device | Model ID | User | User ID |
|--------|----------|------|---------|
| Joakim's iPhone 14 | iPhone14,7 | TestiY | `c7f42ec5-7c6d-4dc4-90f2-2aae6ede4d28` |
| Onni's iPhone 12 | iPhone13,2 | Jokke | `d71425a3-a92f-404e-bfbe-a54c4cb58b6a` |

### API Configuration

- **Production API URL:** `https://api-joakim-achrens-projects.vercel.app`
- **Database:** Supabase with pooler connection (`aws-1-eu-west-1.pooler.supabase.com`)
- **Dev Auth Bypass:** Enabled via `X-Dev-User-Id` header

### Key Config Files

| File | Setting | Value |
|------|---------|-------|
| `app/lib/config/dev_config.dart` | `useProductionApi` | `true` |
| `app/lib/config/dev_config.dart` | `skipAuthInDev` | `true` |
| `api/.env.local` | `AUTH_DEV_BYPASS_ENABLED` | `true` |
| `api/.env.local` | `DATABASE_URL` | Uses `aws-1-eu-west-1.pooler.supabase.com` |

---

## What Was Fixed Today

### 1. Vercel API Deployment
- Created `api/vercel.json` to include puzzle data files in the deployment
- Configured `includeFiles: "data/**"` for serverless functions

### 2. Database Connection Pooler
- Switched from direct Supabase connection to pooler for serverless compatibility
- Fixed region issue: `aws-0-eu-west-1` → `aws-1-eu-west-1`

### 3. Device-Based User Detection
- Updated `auth_service.dart` and `dev_data_service.dart` to detect device model
- iPhone 12 (model `iPhone13,x`) → Jokke
- iPhone 14 (model `iPhone14,x`) → TestiY
- Device name wasn't reliable (returned "iPhone" for both), so we use `iosInfo.utsname.machine`

---

## How to Launch for Testing

### Quick Start (Both Devices)
```bash
cd /Users/joakimachren/Desktop/togetherremind/app

# iPhone 14 (TestiY)
flutter run -d 00008110-00011D4A340A401E

# iPhone 12 (Jokke) - in separate terminal
flutter run -d 00008101-001120A02230001E
```

### If Devices Need Fresh Data
Delete the app from both phones first, then reinstall. This clears local Hive storage and forces fresh user data fetch from Supabase.

### Check Device Connection
```bash
flutter devices
```

Expected output:
```
Joakim's iPhone 14 (mobile) • 00008110-00011D4A340A401E • ios • iOS 26.1
Onni's iPhone 12 (mobile)   • 00008101-001120A02230001E • ios • iOS 26.1
```

---

## Known Issues (Minor)

### 1. RenderFlex Overflow Warning
- **Location:** `new_home_screen.dart:551`
- **Severity:** Cosmetic (0.564 pixels)
- **Impact:** None - just a debug warning

### 2. Device Name Returns "iPhone"
- iOS 26.1 returns generic "iPhone" instead of user-set name
- Workaround: Using device model ID instead

---

## Architecture Overview

```
┌─────────────────┐      ┌─────────────────┐
│  iPhone 14      │      │  iPhone 12      │
│  (TestiY)       │      │  (Jokke)        │
└────────┬────────┘      └────────┬────────┘
         │                        │
         └────────┬───────────────┘
                  │ HTTPS
                  ▼
         ┌─────────────────┐
         │  Vercel API     │
         │  (Next.js)      │
         └────────┬────────┘
                  │
                  ▼
         ┌─────────────────┐
         │  Supabase       │
         │  (Pooler)       │
         └─────────────────┘
```

---

## Files Modified Today

### Flutter App
- `app/lib/services/auth_service.dart` - Device-based user ID detection
- `app/lib/services/dev_data_service.dart` - Device-based user ID detection
- `app/lib/config/dev_config.dart` - `useProductionApi = true`

### API
- `api/vercel.json` - Created for puzzle data bundling
- `api/.env.local` - Database pooler URL (not committed)

---

## Testing Checklist

- [x] API deployed to Vercel
- [x] Database connection via pooler working
- [x] iPhone 14 loads as TestiY
- [x] iPhone 12 loads as Jokke
- [x] Linked game playable on both devices
- [x] Word Search game playable on both devices
- [ ] Test turn-based sync between devices
- [ ] Test game completion flow
- [ ] Test other games (Memory Flip, Quiz, etc.)

---

## Useful Commands

```bash
# Test API directly
curl -X POST \
  -H "Content-Type: application/json" \
  -H "X-Dev-User-Id: c7f42ec5-7c6d-4dc4-90f2-2aae6ede4d28" \
  -d '{"localDate":"2025-11-27"}' \
  "https://api-joakim-achrens-projects.vercel.app/api/sync/linked"

# Check Vercel deployment logs
vercel logs api-joakim-achrens-projects.vercel.app

# Build iOS without running
flutter build ios --debug
```

---

## Next Steps

1. Continue testing turn-based sync between the two devices
2. Test other game types (Memory Flip, Classic Quiz, You or Me)
3. Fix the minor RenderFlex overflow warning if desired
4. Consider adding more test scenarios for edge cases
